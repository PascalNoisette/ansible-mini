
---
- name: Install passwords on mini
  hosts: mini
  become: yes
  tasks:
    - include: tasks/request_credential.yml path_to_check=/etc/nginx/passwords/iu_pa.password
    - name: Make sure we can use htpasswd module
      apt: "pkg=python-passlib state=installed"
      when: file.stat.exists == False
    - name: "Generate htpasswd"
      htpasswd:
        path: /etc/nginx/passwords/iu_pa.password
        name: "{{ username.user_input }}"
        password: "{{ password.user_input }}"
        owner: root
        group: www-data
        mode: 0640
      when: file.stat.exists == False
    - name: Load a variable file based on the OS type, or a default if not found. Using free-form to specify the file.
      include_vars: "{{ lookup('first_found', possible_files, errors='ignore') }}"
      vars:
        possible_files:
          - "vars/{{ ansible_lsb.id }}.yml"
      ignore_errors: yes

- name: Install jdauphant.nginx on mini
  hosts: mini
  become: yes
  tasks:
    - name: Ensures /etc/nginx/conf.d/ dir exists
      file: path=/etc/nginx/conf.d/ state=directory
    - name: Ensures /etc/nginx/site-enabled/ dir exists
      file: path=/etc/nginx/site-enabled/ state=directory
    - name: create conf.d template
      template:
        src: "{{ item }}"
        dest: /etc/nginx/conf.d/{{ item }}
      with_fileglob:
      - ../templates/conf.d/*
    - name: create vhost template
      template:
        src: "{{ item }}"
        dest: /etc/nginx/site-enabled/{{ item }}
      with_fileglob:
      - ../templates/vhost/*
  roles:
    - role: jdauphant.nginx
      nginx_sites:
          default:
               - listen 80
               - listen 8443 ssl
               - server_name netpascal.myvnc.com _
               - root "/var/www/html"
               - index index.html
               - |
                 location /git/ {
                     auth_basic           "git";
                     auth_basic_user_file /etc/nginx/passwords/iu_pa.password;
                     proxy_pass         http://127.0.0.1:10080/;
                 }
               - |
                 location /joplin/ {
                     proxy_pass http://localhost:41185/joplin/;
                     auth_basic           "joplin";
                     auth_basic_user_file /etc/nginx/passwords/iu_pa.password;
                 }
               - |
                 location /rssme/ {
                     proxy_pass         http://127.0.0.1:3000/;
                 }
               - |
                 location /pub {
                     autoindex on;
                     auth_basic "Public";
                     auth_basic_user_file /etc/nginx/passwords/iu_pa.password;
                 }
